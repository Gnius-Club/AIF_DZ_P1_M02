<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Guardianes del Sal√≥n: Escuadr√≥n de Cuidado</title>
<style>
:root{
  --bg1:#0f1b2d; --bg2:#153b5b; --brand:#32e6a1; --accent:#ffd54d;
  --danger:#ff5b6e; --ok:#5be38b; --tool:#8bd3ff; --panel:#11263b;
  --text:#eaf6ff; --muted:#9fc3d9; --cape:#ff4dd8; --cape-dark:#c23aa6;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",Helvetica,Arial,sans-serif}
button{font:inherit}
#app{max-width:1040px;margin:0 auto;padding:12px}

/* Pantalla verde de inicio */
#startScreen{
  position:fixed;inset:0;z-index:10000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;
  background:#11c76b;color:#063a22;text-align:center;cursor:pointer;user-select:none;
}
#startScreen h1{margin:0;font-size:clamp(28px,5vw,44px)}
.startBtn{pointer-events:none;padding:12px 18px;border-radius:14px;border:0;background:#0a8c4b;color:#fff;font-weight:900;font-size:20px;box-shadow:0 6px 0 rgba(0,0,0,.2)}

/* HUD */
.topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);padding:10px 12px;border-radius:14px;backdrop-filter:blur(4px)}
.badge{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1);font-weight:700}
#orderWrap{flex:1;margin:0 10px;height:16px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);position:relative;overflow:hidden}
#orderBar{position:absolute;left:0;top:0;bottom:0;width:100%;background:linear-gradient(90deg,#2ee6a1,#56ffa8);box-shadow:0 0 12px #2ee6a1 inset;transition:width .25s}
.hi{box-shadow:0 0 0 3px var(--accent) inset,0 0 16px rgba(255,213,77,.35)!important;transform:scale(1.02)}
.flash{animation:flash 1.4s ease-in-out 2}@keyframes flash{50%{filter:brightness(1.35)}}

/* Juego */
.screen{display:block}
.card{border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));box-shadow:0 8px 24px rgba(0,0,0,.35)}
.board{margin-top:12px;display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.station{position:relative;min-height:160px;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.12);overflow:hidden}
.avatar{position:absolute;left:10px;top:8px;font-size:40px;filter:drop-shadow(0 2px 0 rgba(0,0,0,.3))}
.cape{position:absolute;left:26px;top:36px;width:26px;height:18px;background:linear-gradient(180deg,var(--cape),var(--cape-dark));border-radius:0 0 16px 16px;transform:skewX(-12deg) rotate(-6deg);opacity:.85}
.tablet2{position:absolute;right:12px;bottom:12px;width:100px;height:64px;border-radius:10px;background:linear-gradient(180deg,#1a3350,#0e2136);border:2px solid #3cc1ff;box-shadow:0 8px 16px rgba(60,193,255,.25)}
.event{position:absolute;right:18px;top:10px;display:flex;gap:6px;align-items:center;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.18);padding:6px 8px;border-radius:12px;backdrop-filter:blur(2px)}
.icon{font-size:22px}
.timer{width:90px;height:8px;border-radius:999px;background:rgba(255,255,255,.15);overflow:hidden;border:1px solid rgba(255,255,255,.2)}
.timer>i{display:block;height:100%;width:100%;background:linear-gradient(90deg,#2ee6a1,#9cffd1)}
.fade{animation:fade .2s linear 3}@keyframes fade{50%{opacity:.4}}

/* Cintur√≥n */
.belt{position:sticky;bottom:6px;margin-top:10px;display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
.tool{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:120px;padding:10px;border-radius:16px;border:2px solid var(--tool);background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));cursor:grab;touch-action:none;box-shadow:0 6px 0 rgba(0,0,0,.25)}
.tool .ticon{font-size:26px}
.tool .tname{font-weight:800;color:#cfeeff;text-align:center}
.tool.breathe{animation:breath 1.6s ease-in-out infinite}@keyframes breath{50%{transform:translateY(-2px);box-shadow:0 8px 0 rgba(0,0,0,.25)}}
.belt.disabled{pointer-events:none;opacity:.75}

/* Fantasma de arrastre */
.ghost{position:fixed;left:0;top:0;transform:translate(-9999px,-9999px);pointer-events:none;padding:8px 12px;border-radius:999px;background:#0b1c2b;border:2px solid var(--tool);z-index:9999}

/* Frases */
#phrase{margin-top:8px;text-align:center;font-weight:800;color:#cdefff;min-height:26px}

/* Modal final ‚Äì opaco, con botones de color */
.modal{position:fixed;inset:0;background:#08131f;display:none;align-items:center;justify-content:center;z-index:9998;padding:12px}
.modal.show{display:flex}
.modal .inner{width:min(720px,96%);background:#0f2236;border:1px solid rgba(255,255,255,.25);border-radius:16px;padding:16px;box-shadow:0 24px 60px rgba(0,0,0,.6)}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.action{padding:12px 16px;border-radius:14px;border:2px solid transparent;cursor:pointer;font-weight:900;font-size:18px}

/* Botones de color (alto contraste) */
.btn-blue{background:#1e63ff;border-color:#0a3ed4;color:#ffffff}
.btn-blue:focus{outline:3px solid #9db5ff}
.btn-green{background:#13b26b;border-color:#0a7a49;color:#ffffff}
.btn-green:focus{outline:3px solid #a7f3c3}
.btn-red{background:#f04444;border-color:#b01212;color:#ffffff}
.btn-red:focus{outline:3px solid #ffc0c0}

/* Bot√≥n Saltar tutorial */
#skipTut{position:fixed;top:8px;right:8px;z-index:9999;display:none;padding:10px 12px;border-radius:12px;border:2px solid var(--accent);background:rgba(255,213,77,.25);color:#fff;font-weight:900;cursor:pointer}

/* Temas */
.theme-lab{--bg1:#141530;--bg2:#2a2457;--brand:#9b7bff}
.theme-library{--bg1:#1b2a18;--bg2:#2d4a25;--brand:#7bd77b}
</style>
</head>
<body>
<!-- Inicio verde -->
<div id="startScreen" role="button" aria-label="Iniciar tutorial. Toca en cualquier lugar.">
  <h1>Guardianes del Sal√≥n</h1>
  <div class="startBtn">Iniciar</div>
  <div style="opacity:.9;font-weight:800">Toca o haz clic en cualquier parte para comenzar</div>
</div>

<!-- Saltar tutorial -->
<button id="skipTut" aria-label="Saltar tutorial">‚è≠Ô∏è Saltar tutorial</button>

<div id="app" aria-live="polite">
  <div class="topbar">
    <div class="badge" id="scenarioName">Sal√≥n de Tecnolog√≠a</div>
    <div id="orderWrap" aria-label="Medidor de Orden del Sal√≥n"><div id="orderBar"></div></div>
    <div class="badge">Ronda: <span id="roundTxt">0</span>/3</div>
    <div class="badge">Puntos: <span id="scoreTxt">0</span></div>
    <div class="badge">R√©cord: <span id="hiTxt">0</span></div>
    <button class="action btn-green" id="openCfg" aria-label="Abrir configuraci√≥n">‚öôÔ∏è</button>
  </div>

  <div id="phrase"></div>

  <section id="game" class="screen">
    <div class="board" id="board"></div>
    <div class="belt">
      <div class="tool breathe" data-tool="cloth" role="button" aria-grabbed="false" tabindex="0"><div class="ticon">üßº</div><div class="tname">Pa√±o Seco</div></div>
      <div class="tool breathe" data-tool="turns" role="button" aria-grabbed="false" tabindex="0"><div class="ticon">‚è≥</div><div class="tname">Reloj de Espera</div></div>
      <div class="tool breathe" data-tool="power" role="button" aria-grabbed="false" tabindex="0"><div class="ticon">‚ö´</div><div class="tname">Bot√≥n de Apagado</div></div>
    </div>
  </section>

  <!-- Modal final (opaco + botones de color) -->
  <div id="endModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="endTitle">
    <div class="inner">
      <div class="row" style="justify-content:space-between">
        <div class="h1" id="endTitle">Resultado</div>
        <div class="h1">R√©cord: <span id="finalHi">0</span></div>
      </div>
      <p class="p" id="endMsg"></p>
      <div class="row" style="justify-content:space-between">
        <div class="h1">Puntuaci√≥n: <span id="finalScore">0</span> <span class="medal" id="medal"></span></div>
      </div>
      <div class="row" style="margin-top:14px;justify-content:center">
        <button class="action btn-blue" id="retryBtn" aria-label="Bot√≥n azul: Volver a jugar">üîµ Volver a jugar</button>
        <button class="action btn-green" id="menuBtn" aria-label="Bot√≥n verde: Volver al inicio">üü¢ Volver al inicio</button>
        <!-- Opcional de ejemplo: bot√≥n rojo (oculto por defecto). Para activarlo, quita display:none en style -->
        <button class="action btn-red" id="exitBtn" style="display:none" aria-label="Bot√≥n rojo: Salir del juego">üî¥ Salir</button>
      </div>
      <hr style="border-color:rgba(255,255,255,.2)">
      <div class="h1" style="color:var(--accent)">Escenarios desbloqueables</div>
      <div class="row">
        <button class="action btn-green" id="unlockLibrary" disabled>üìö Biblioteca Digital</button>
        <button class="action btn-green" id="unlockLab" disabled>üß™ Laboratorio de Rob√≥tica</button>
      </div>
    </div>
  </div>

  <!-- Config -->
  <div id="cfgModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="cfgTitle">
    <div class="inner">
      <div class="h1" id="cfgTitle">Personalizaci√≥n</div>
      <div class="row">
        <label>Capa: <input id="capePicker" type="color" value="#ff4dd8"></label>
        <label>Herramientas:
          <select id="toolStyle"><option value="default">Cl√°sico</option><option value="rounded">Redondeado</option><option value="square">Cuadrado</option></select>
        </label>
        <label>Escenario:
          <select id="scenarioSel">
            <option value="tech">Sal√≥n de Tecnolog√≠a</option>
            <option value="library" disabled>Biblioteca Digital (bloqueado)</option>
            <option value="lab" disabled>Laboratorio de Rob√≥tica (bloqueado)</option>
          </select>
        </label>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="action btn-blue" id="saveCfg">Guardar</button>
        <button class="action btn-green" id="closeCfg">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
(()=> {
  const el = s => document.querySelector(s);
  const els = s => Array.from(document.querySelectorAll(s));
  const board=el('#board'), orderBar=el('#orderBar'), roundTxt=el('#roundTxt'), scoreTxt=el('#scoreTxt'), phrase=el('#phrase');
  const endModal=el('#endModal'), cfgModal=el('#cfgModal'), scenarioName=el('#scenarioName'), startScreen=el('#startScreen'), skipBtn=el('#skipTut'), hiTxt=el('#hiTxt');

  const VOICE_RATE=.95, ORDER_MAX=100;

  let score=0, order=ORDER_MAX, round=0, running=false;
  let eventsActive=[], ghost=null, dragTool=null;
  let isTutorial=false, tutorialCanceled=false, suppressTutorialSpeech=false, lockInput=false;
  let highScore= +localStorage.getItem('guardianes_hi') || 0; hiTxt.textContent=highScore;

  let settings = loadSettings();

  const stations = new Array(4).fill(0).map((_,i)=>({id:i,el:null,busy:false}));

  const EVENT_TYPES={
    cloth:{key:'cloth',icon:'üíß',target:'avatar',tool:'cloth',name:'Cuidado del material',successVoice:'¬°Alto ah√≠! El agua puede causar un cortocircuito. ¬°Usa este pa√±o seco!',phrase:'¬°Para la pantalla sucia, un pa√±o seco es la astucia!'},
    turns:{key:'turns',icon:'‚úã',target:'avatar',tool:'turns',name:'Respeto de turnos',successVoice:'¬°Un momento! Respetar el turno es jugar en equipo.',phrase:'¬°El turno es sagrado, respeto asegurado!'},
    power:{key:'power',icon:'üîã',target:'tablet',tool:'power',name:'Apagado responsable',successVoice:'¬°Espera! Si apagamos, tu compa√±ero tendr√° bater√≠a.',phrase:'¬°Apagar al terminar, energ√≠a para empezar!'}
  };

  const DIFF=[{time:5000,concurrent:1,spawnDelay:[900,1300]},{time:4000,concurrent:1,spawnDelay:[750,1100]},{time:3000,concurrent:2,spawnDelay:[600,950]}];
  const RONDA_SPAWNS=[8,10,12]; let spawnsDone=0;

  // --------- Utils: Voz ---------
  function cancelVoice(){ try{ speechSynthesis.cancel(); }catch(e){} }
  function gameSpeak(text){
    try{ const u=new SpeechSynthesisUtterance(text); u.lang='es-MX'; u.rate=VOICE_RATE; speechSynthesis.speak(u);}catch(e){}
  }
  function tSpeakAsync(text){
    return new Promise(res=>{
      if(suppressTutorialSpeech) return res();
      try{ const u=new SpeechSynthesisUtterance(text); u.lang='es-MX'; u.rate=VOICE_RATE; u.onend=()=>res(); u.onerror=()=>res(); speechSynthesis.speak(u);}catch(e){ res(); }
    });
  }
  function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }
  function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function setOrder(v){ order=Math.max(0,Math.min(ORDER_MAX,v)); orderBar.style.width=(order/ORDER_MAX*100)+'%'; }
  function addPoints(n){ score+=n; scoreTxt.textContent=score; }
  function showPhrase(msg){ phrase.textContent=msg; phrase.classList.add('fade'); setTimeout(()=>phrase.classList.remove('fade'),400); }
  function flash(e){ if(!e) return; e.classList.add('flash'); setTimeout(()=>e.classList.remove('flash'),1300); }
  function highlight(e,on=true){ if(!e) return; e.classList.toggle('hi',!!on); }

  // --------- Settings / Tema ---------
  function loadSettings(){
    const raw=localStorage.getItem('guardianes_settings'); let def={cape:'#ff4dd8',toolStyle:'default',scenario:'tech',unlocked:{library:false,lab:false}};
    if(raw){ try{ def=Object.assign(def,JSON.parse(raw)); }catch(e){} }
    applyTheme(def); return def;
  }
  function saveSettings(){ localStorage.setItem('guardianes_settings',JSON.stringify(settings)); }
  function applyTheme(s){
    document.documentElement.style.setProperty('--cape', s.cape||'#ff4dd8');
    document.documentElement.style.setProperty('--cape-dark', shadeColor(s.cape||'#ff4dd8', -20));
    document.body.classList.remove('theme-lab','theme-library');
    if(s.scenario==='library'){ document.body.classList.add('theme-library'); scenarioName.textContent='Biblioteca Digital'; }
    else if(s.scenario==='lab'){ document.body.classList.add('theme-lab'); scenarioName.textContent='Laboratorio de Rob√≥tica'; }
    else{ scenarioName.textContent='Sal√≥n de Tecnolog√≠a'; }
    el('#scenarioSel').querySelector('option[value="library"]').disabled=!s.unlocked?.library;
    el('#scenarioSel').querySelector('option[value="lab"]').disabled=!s.unlocked?.lab;
    el('#unlockLibrary').disabled=!s.unlocked?.library;
    el('#unlockLab').disabled=!s.unlocked?.lab;
  }
  function shadeColor(hex,p){ const f=parseInt(hex.slice(1),16),t=p<0?0:255,P=Math.abs(p)/100,R=f>>16,G=f>>8&0x00FF,B=f&0x0000FF;return '#'+(0x1000000+(Math.round((t-R)*P)+R)*0x10000+(Math.round((t-G)*P)+G)*0x100+(Math.round((t-B)*P)+B)).toString(16).slice(1); }

  // --------- Tablero ---------
  function buildBoard(){
    board.innerHTML=''; stations.forEach(st=>{
      const d=document.createElement('div'); d.className='station'; d.dataset.id=st.id;
      d.innerHTML=`<div class="avatar">${['üßë','üëß','üë¶','üßí'][st.id%4]}</div><div class="cape"></div><div class="tablet2"></div>`;
      st.el=d; st.busy=false; board.appendChild(d);
    });
  }

  // --------- Eventos ---------
  function canSpawnMore(){ const conf=DIFF[round-1]; return eventsActive.length<conf.concurrent; }
  function spawnEvent(){
    const conf=DIFF[round-1], typeKey=['cloth','turns','power'][rand(0,2)];
    const free=stations.filter(s=>!s.busy); if(!free.length) return;
    const st=free[rand(0,free.length-1)]; return spawnEventCustom(typeKey,st.id,conf.time);
  }
  function spawnEventCustom(typeKey,stationIndex,timeMs){
    const type=EVENT_TYPES[typeKey], st=stations[stationIndex]; if(!st||st.busy) return null;
    st.busy=true; const evEl=document.createElement('div'); evEl.className='event'; evEl.innerHTML=`<span class="icon">${type.icon}</span><div class="timer"><i></i></div>`; st.el.appendChild(evEl);
    const timerBar=evEl.querySelector('i'); let start=performance.now(), ended=false;
    const ev={station:st,type,el:evEl,timerBar};
    function tick(now){ if(ended) return; const t=(now-start)/timeMs, rem=Math.max(0,1-t); timerBar.style.width=(rem*100)+'%'; if(rem<=0){ finishFail(); return; } ev.frame=requestAnimationFrame(tick); }
    ev.frame=requestAnimationFrame(tick);
    function finishSuccess(){ if(ended) return; ended=true; cancelAnimationFrame(ev.frame); st.busy=false; evEl.remove(); eventsActive=eventsActive.filter(e=>e!==ev); addPoints(10); setOrder(order+8); showPhrase(type.phrase); gameSpeak(type.successVoice); st.el.classList.add('fade'); setTimeout(()=>st.el.classList.remove('fade'),200); checkProgress(); }
    function finishFail(){ if(ended) return; ended=true; cancelAnimationFrame(ev.frame); st.busy=false; evEl.remove(); eventsActive=eventsActive.filter(e=>e!==ev); addPoints(-10); setOrder(order-20); showPhrase('¬°Ups! Observa y vuelve a intentarlo. Recuerda las 3 reglas.'); gameSpeak('Ha ocurrido un accidente. Revisa la regla adecuada.'); st.el.style.transition='transform .08s'; st.el.style.transform='translateX(-4px)'; setTimeout(()=>st.el.style.transform='translateX(4px)',80); setTimeout(()=>st.el.style.transform='',160); checkProgress(); }
    ev.finishSuccess=finishSuccess; ev.finishFail=finishFail; eventsActive.push(ev); return ev;
  }
  function checkProgress(){ if(order<=0){ endGame(false); return; } }

  async function startRound(n){
    round=n; roundTxt.textContent=round; spawnsDone=0;
    eventsActive.forEach(e=>{ try{cancelAnimationFrame(e.frame); e.el.remove(); e.station.busy=false;}catch(_){} }); eventsActive=[];
    const conf=DIFF[n-1];
    while(running && round===n){
      if(spawnsDone>=RONDA_SPAWNS[n-1] && eventsActive.length===0) break;
      if(canSpawnMore() && spawnsDone<RONDA_SPAWNS[n-1]){ spawnEvent(); spawnsDone++; }
      await wait(rand(conf.spawnDelay[0], conf.spawnDelay[1]));
    }
    while(running && eventsActive.length>0){ await wait(50); }
    if(!running) return;
    if(order<=0){ endGame(false); return; }
    if(n<3){ gameSpeak(`Ronda ${n} completada. Prep√°rate.`); await wait(700); startRound(n+1); } else { endGame(true); }
  }

  // --------- Juego principal ---------
  function startGame(){
    lockInput=false; isTutorial=false; tutorialCanceled=false; suppressTutorialSpeech=false;
    hideSkip(); cancelVoice();
    if(ghost) ghost.style.transform='translate(-9999px,-9999px)';

    score=0; order=ORDER_MAX; setOrder(order); scoreTxt.textContent='0'; phrase.textContent=''; round=0; roundTxt.textContent='0';
    buildBoard(); running=true; el('.belt').classList.remove('disabled');
    gameSpeak('¬°Comienza la misi√≥n! Observa las estaciones y act√∫a con rapidez.');
    startRound(1);
  }

  function endGame(victory){
    running=false;
    if(score>highScore){ highScore=score; localStorage.setItem('guardianes_hi',String(highScore)); }
    el('#finalScore').textContent=score; hiTxt.textContent=highScore; el('#finalHi').textContent=highScore;
    let med='ü•â'; if(score>=220) med='ü•à'; if(score>=280) med='ü•á'; el('#medal').textContent=med;

    if(victory){
      el('#endMsg').innerHTML='¬°Victoria! Mantuvimos el Orden del Sal√≥n. Recibe la <b>Capa de Guardi√°n L√≠der</b>.';
    }else{
      el('#endMsg').innerHTML='El Orden del Sal√≥n lleg√≥ a cero. Repasemos las reglas y volvamos a intentar.';
    }

    // Explicaci√≥n por voz orientada por color
    cancelVoice();
    gameSpeak('Pantalla final. Escucha: El bot√≥n AZUL dice "Volver a jugar". T√≥calo para empezar otra partida. El bot√≥n VERDE dice "Volver al inicio". T√≥calo para regresar a la pantalla verde.');

    endModal.classList.add('show');
  }

  // --------- Drag & Drop ---------
  function makeGhost(label){ if(!ghost){ ghost=document.createElement('div'); ghost.className='ghost'; document.body.appendChild(ghost); } ghost.textContent=label; return ghost; }
  function onPointerDownTool(ev){
    if(lockInput) return;
    const t=ev.currentTarget; dragTool={type:t.dataset.tool, el:t}; t.setAttribute('aria-grabbed','true');
    const label=t.querySelector('.ticon').textContent+' '+t.querySelector('.tname').textContent;
    const g=makeGhost(label); g.style.transform=`translate(${ev.clientX}px, ${ev.clientY}px)`;
    addGlobalDragListeners();
  }
  function onPointerMove(ev){ if(!dragTool) return; ghost.style.transform=`translate(${ev.clientX+12}px, ${ev.clientY+6}px)`; }
  function onPointerUp(ev){
    if(!dragTool){ removeGlobalDragListeners(); return; }
    const drop=document.elementFromPoint(ev.clientX,ev.clientY); const stationEl=drop?.closest?.('.station');
    if(stationEl){ const stId=+stationEl.dataset.id; const evMatch=eventsActive.find(e=>e.station.id===stId); if(evMatch){ evMatch.type.tool===dragTool.type ? evMatch.finishSuccess() : evMatch.finishFail(); } }
    dragTool.el.setAttribute('aria-grabbed','false'); dragTool=null; if(ghost) ghost.style.transform='translate(-9999px,-9999px)'; removeGlobalDragListeners();
  }
  function addGlobalDragListeners(){ window.addEventListener('pointermove',onPointerMove); window.addEventListener('pointerup',onPointerUp,{once:true}); }
  function removeGlobalDragListeners(){ window.removeEventListener('pointermove',onPointerMove); window.removeEventListener('pointerup',onPointerUp); }

  els('.tool').forEach(t=>{
    t.addEventListener('pointerdown', onPointerDownTool);
    t.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); onPointerDownTool({currentTarget:t, clientX:0, clientY:0}); }});
  });

  // --------- Tutorial (cancelable y con salto) ---------
  function centerOf(elm){ const r=elm.getBoundingClientRect(); return {x:r.left+r.width/2, y:r.top+r.height/2}; }
  async function animateToolToStation(toolType, stationIndex, succeed=true, evObj=null, ms=900){
    const toolEl=el(`.tool[data-tool="${toolType}"]`), stationEl=stations[stationIndex]?.el; if(!toolEl||!stationEl) return;
    const label=toolEl.querySelector('.ticon').textContent+' '+toolEl.querySelector('.tname').textContent, g=makeGhost(label);
    const from=centerOf(toolEl), to=centerOf(stationEl), start=performance.now(); highlight(toolEl,true); highlight(stationEl,true);
    await new Promise(resolve=>{
      function step(now){ const t=Math.min(1,(now-start)/ms), x=from.x+(to.x-from.x)*t, y=from.y+(to.y-from.y)*t; g.style.transform=`translate(${x}px, ${y}px)`; if(t<1){ requestAnimationFrame(step); } else { setTimeout(()=>{ if(evObj){ succeed?evObj.finishSuccess():evObj.finishFail(); } g.style.transform='translate(-9999px,-9999px)'; highlight(toolEl,false); highlight(stationEl,false); resolve(); },120);} }
      requestAnimationFrame(step);
    });
  }

  async function runTutorial(){
    cancelVoice();
    isTutorial=true; tutorialCanceled=false; suppressTutorialSpeech=false; lockInput=true;
    el('.belt').classList.add('disabled'); showSkip();

    score=0; order=ORDER_MAX; setOrder(order); scoreTxt.textContent='0'; round=0; roundTxt.textContent='0'; buildBoard(); phrase.textContent='';

    try{
      await tSpeakAsync('¬°Bienvenido, Guardi√°n! Mant√©n el Orden del Sal√≥n usando tres reglas.');
      flash(el('#orderWrap')); highlight(el('#orderWrap'),true); await tSpeakAsync('Arriba est√° el Medidor de Orden. Si aciertas, sube. Si fallas, baja.'); highlight(el('#orderWrap'),false);
      flash(el('#roundTxt').parentElement); highlight(el('#roundTxt').parentElement,true); await tSpeakAsync('Jugar√°s tres rondas con dificultad progresiva.'); highlight(el('#roundTxt').parentElement,false);
      flash(el('#scoreTxt').parentElement); highlight(el('#scoreTxt').parentElement,true); await tSpeakAsync('Cada acierto suma diez puntos y cada error resta diez.'); highlight(el('#scoreTxt').parentElement,false);
      const belt=el('.belt'); flash(belt); highlight(belt,true); await tSpeakAsync('Este es tu cintur√≥n. Arrastra la herramienta correcta a la estaci√≥n con el problema.'); highlight(belt,false);

      const ev1=spawnEventCustom('cloth',0,6000); await tSpeakAsync('Herramienta uno: Pa√±o seco. Si ves una gota, nunca uses agua.'); await animateToolToStation('cloth',0,true,ev1,900); await tSpeakAsync('Para la pantalla sucia, un pa√±o seco es la astucia.');
      const ev2=spawnEventCustom('turns',1,6000); await tSpeakAsync('Herramienta dos: Reloj de espera. Si alguien arrebata, recordamos respetar el turno.'); await animateToolToStation('turns',1,true,ev2,900); await tSpeakAsync('El turno es sagrado, respeto asegurado.');
      const ev3=spawnEventCustom('power',2,6000); await tSpeakAsync('Herramienta tres: Bot√≥n de apagado. Si una tablet queda sola con bater√≠a baja, la apagamos.'); await animateToolToStation('power',2,true,ev3,900); await tSpeakAsync('Apagar al terminar, energ√≠a para empezar.');
      const ev4=spawnEventCustom('turns',3,5000); flash(stations[3].el); await tSpeakAsync('F√≠jate en la barra de tiempo. Si se vac√≠a, ocurre un accidente.'); await animateToolToStation('turns',3,true,ev4,900);
      const evFail=spawnEventCustom('cloth',0,6000); await tSpeakAsync('Observa un error: aqu√≠ va pa√±o seco, pero pondr√© apagado por error.'); await animateToolToStation('power',0,false,evFail,900); await tSpeakAsync('Perdimos puntos y baj√≥ el Orden. Aprendemos y seguimos.');
      await tSpeakAsync('¬°Listo! Ahora empieza la misi√≥n.');
    }catch(e){}
    startGame();
  }

  function showSkip(){ skipBtn.style.display='block'; }
  function hideSkip(){ skipBtn.style.display='none'; }

  // Inicio verde
  function hideStartScreen(){ startScreen.style.display='none'; }
  function showStartScreen(){ startScreen.style.display='flex'; }
  startScreen.addEventListener('click', ()=>{ hideStartScreen(); runTutorial(); });
  window.addEventListener('keydown', e=>{ if(startScreen.style.display!=='none' && (e.key==='Enter'||e.key===' ')){ hideStartScreen(); runTutorial(); } });

  // Saltar tutorial (silencia voz del tutorial)
  skipBtn.addEventListener('click', ()=>{
    tutorialCanceled=true;
    suppressTutorialSpeech=true;
    cancelVoice();
    startGame();
  });

  // Botones modal/config
  el('#retryBtn').addEventListener('click', ()=>{ endModal.classList.remove('show'); startGame(); });
  el('#menuBtn').addEventListener('click', ()=>{ endModal.classList.remove('show'); cancelVoice(); showStartScreen(); });
  const exitBtn = el('#exitBtn');
  if(exitBtn){
    exitBtn.addEventListener('click', ()=>{ cancelVoice(); // comportamiento opcional
      // window.close(); // la mayor√≠a de navegadores no permiten cerrar pesta√±as no abiertas por script
      showStartScreen(); endModal.classList.remove('show');
    });
  }

  el('#openCfg').addEventListener('click', ()=>{
    el('#capePicker').value=settings.cape||'#ff4dd8';
    el('#toolStyle').value=settings.toolStyle||'default';
    const sel=el('#scenarioSel'); sel.value=settings.scenario||'tech';
    sel.querySelector('option[value="library"]').disabled=!settings.unlocked.library;
    sel.querySelector('option[value="lab"]').disabled=!settings.unlocked.lab;
    cfgModal.classList.add('show');
  });
  el('#saveCfg').addEventListener('click', ()=>{
    settings.cape=el('#capePicker').value; settings.toolStyle=el('#toolStyle').value; settings.scenario=el('#scenarioSel').value;
    saveSettings(); applyTheme(settings);
    els('.tool').forEach(t=>{ t.style.borderRadius = settings.toolStyle==='square' ? '8px' : settings.toolStyle==='rounded' ? '22px' : '16px'; });
    cfgModal.classList.remove('show');
  });
  el('#closeCfg').addEventListener('click', ()=>cfgModal.classList.remove('show'));
  el('#unlockLibrary').addEventListener('click', ()=>{ settings.scenario='library'; saveSettings(); applyTheme(settings); endModal.classList.remove('show'); });
  el('#unlockLab').addEventListener('click', ()=>{ settings.scenario='lab'; saveSettings(); applyTheme(settings); endModal.classList.remove('show'); });

  // Inicializaci√≥n
  buildBoard();
  setInterval(()=>{ els('.tool').forEach(t=>t.classList.toggle('breathe')); },1800);
})();
</script>
</body>
</html>
